<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Uppy File Uploader</title>

    <!-- Uppy CSS -->
    <link
      rel="stylesheet"
      href="https://releases.transloadit.com/uppy/v3.6.0/uppy.min.css"
    />
  </head>

  <body>
    <div id="drag-drop-area"></div>

    <!-- Uppy JS -->
    <script type="module">
  import Uppy from 'https://cdn.jsdelivr.net/npm/@uppy/core@3.4.1/dist/uppy.min.mjs';

  const uppy = new Uppy.Uppy({
    debug: true,
    autoProceed: false,
  });

  uppy.use(Uppy.Dashboard, {
    inline: true,
    target: '#drag-drop-area',
    showProgressDetails: true,
    proudlyDisplayPoweredByUppy: false,
  });

  uppy.on('file-added', (file) => {
    console.log('File added:', file.name);
  });

  uppy.on('upload', async () => {
    for (const fileID of uppy.getFiles().map(f => f.id)) {
      const file = uppy.getFile(fileID);

      // üîó Step 1: Get presigned URL
      const response = await fetch('https://qfiknfbru7xmrtczcqy2767hju0innfi.lambda-url.us-west-2.on.aws/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          filename: file.name,
          filetype: file.type
        })
      });

      const { uploadUrl, key } = await response.json();
      console.log('Presigned URL received for', file.name, key);

      // üõ´ Step 2: Upload to S3
      const upload = await fetch(uploadUrl, {
        method: 'PUT',
        headers: {
          'Content-Type': file.type
        },
        body: file.data
      });

      if (upload.ok) {
        console.log(`‚úÖ ${file.name} uploaded successfully to S3`);
      } else {
        console.error(`‚ùå ${file.name} failed to upload`, await upload.text());
      }
    }

    alert('All files uploaded!');
  });
</script>
  </body>
</html>
